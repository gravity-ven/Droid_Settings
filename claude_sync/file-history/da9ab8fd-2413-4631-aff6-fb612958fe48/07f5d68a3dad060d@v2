#!/usr/bin/env bash

# GitHub Auto-Sync Script
# Bidirectionally syncs all GitHub repositories every 10 minutes

LOG_FILE="$HOME/.local/log/github-autosync.log"
LOCK_FILE="$HOME/.local/tmp/github-autosync.lock"

# Create directories if they don't exist
mkdir -p "$HOME/.local/log" "$HOME/.local/tmp"

# Function to log messages
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*" >> "$LOG_FILE"
}

# Prevent concurrent runs
if [ -f "$LOCK_FILE" ]; then
    log "Another sync is running, skipping..."
    exit 0
fi

touch "$LOCK_FILE"
trap 'rm -f "$LOCK_FILE"' EXIT

log "=========================================="
log "Starting GitHub auto-sync"
log "=========================================="

# Find all GitHub repositories
python3 -c "
import os
import subprocess
from pathlib import Path

home = Path.home()
repos = []

for root, dirs, files in os.walk(home):
    depth = root[len(str(home)):].count(os.sep)
    if depth > 3:
        dirs[:] = []
        continue

    if '.git' in dirs:
        try:
            result = subprocess.run(
                ['git', 'remote', '-v'],
                cwd=root,
                capture_output=True,
                text=True,
                timeout=5
            )
            if 'github.com' in result.stdout:
                repos.append(root)
        except:
            pass
        dirs.remove('.git')

for repo in repos:
    print(repo)
" | while IFS= read -r repo_dir; do
    log "Processing: $repo_dir"

    cd "$repo_dir" || continue

    # Get current branch
    current_branch=$(git rev-parse --abbrev-ref HEAD 2>/dev/null)

    if [ -z "$current_branch" ] || [ "$current_branch" = "HEAD" ]; then
        log "  ‚ö†Ô∏è  Detached HEAD or no branch, skipping"
        continue
    fi

    # Fetch latest changes
    log "  Fetching from remote..."
    if git fetch origin 2>&1; then

        # Check for uncommitted changes
        if ! git diff-index --quiet HEAD -- 2>/dev/null; then
            log "  üìù Uncommitted changes detected, committing..."
            git add -A
            git commit -m "Auto-sync: $(date '+%Y-%m-%d %H:%M:%S')" 2>&1 >> "$LOG_FILE"
        fi

        # Check if remote branch exists
        if git rev-parse --verify "origin/$current_branch" >/dev/null 2>&1; then
            # Check if we're behind remote
            LOCAL=$(git rev-parse @ 2>/dev/null)
            REMOTE=$(git rev-parse "origin/$current_branch" 2>/dev/null)
            BASE=$(git merge-base @ "origin/$current_branch" 2>/dev/null)

            if [ "$LOCAL" = "$REMOTE" ]; then
                log "  ‚úì Already up to date"
            elif [ "$LOCAL" = "$BASE" ]; then
                log "  ‚¨áÔ∏è  Pulling changes..."
                git pull origin "$current_branch" 2>&1 >> "$LOG_FILE"
            elif [ "$REMOTE" = "$BASE" ]; then
                log "  ‚¨ÜÔ∏è  Pushing changes..."
                git push origin "$current_branch" 2>&1 >> "$LOG_FILE"
            else
                log "  ‚ö†Ô∏è  Diverged - attempting merge..."
                if git pull origin "$current_branch" --no-edit 2>&1 >> "$LOG_FILE"; then
                    log "  ‚¨ÜÔ∏è  Pushing merged changes..."
                    git push origin "$current_branch" 2>&1 >> "$LOG_FILE"
                else
                    log "  ‚ùå Merge conflict - manual intervention required"
                fi
            fi
        else
            log "  üÜï No remote branch, pushing..."
            git push -u origin "$current_branch" 2>&1 >> "$LOG_FILE"
        fi
    else
        log "  ‚ùå Fetch failed"
    fi

    log ""
done

log "GitHub auto-sync completed"
log "=========================================="
