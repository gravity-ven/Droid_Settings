# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Repository Overview

**Spartan Research Station** - A comprehensive financial market research platform with real-time analysis tools.

**Platform**: macOS (Darwin 25.1.0)
**Working Directory**: `/Users/spartan/Downloads/spartan_labs`
**Main Content**: `website/` directory contains all application code
**Important**: More detailed guidance exists in `website/CLAUDE.md` - refer to it for deeper architecture details

## Critical Architecture Rules

### ðŸš¨ PLATINUM RULE #1: ABSOLUTELY ZERO FAKE DATA

**This is the HIGHEST PRIORITY rule across the entire codebase.**

Users make real financial decisions with real money. Fake data = securities fraud = illegal.

**Absolutely Forbidden:**
- âŒ `Math.random()` for ANY financial, economic, or market data
- âŒ Made-up statistics, percentages, or correlations
- âŒ Sample/mock/placeholder data for prices, returns, or metrics
- âŒ Hallucinated facts presented as verified data

**Required:**
- âœ… Use ONLY verified data from official sources (FRED, Yahoo Finance, CoinGecko, Alpha Vantage, BLS, Census, Fed)
- âœ… State "Data not available" if real data doesn't exist
- âœ… Mark placeholders CLEARLY with console and UI warnings
- âœ… Cite sources for all specific numbers and statistics

### ðŸ’Ž DIAMOND RULE: Fix Before User Knows

Users should NEVER see errors, bugs, or broken functionality.

**Autonomous Self-Healing:**
- Detect issues autonomously before deployment
- Fix silently without user intervention
- Validate all pages load correctly
- Clear cache automatically
- Only open/deploy when 100% ready

### ðŸ›ï¸ ARCHITECTURE MANTRA: Single Entry Point

**From ARCHITECTURE_MANTRA.md**: "ALL SCRIPTS CONVERGE TO START_SPARTAN.bat"

While the codebase has Windows heritage (`.bat` files), on macOS:
- Never create standalone startup scripts
- Integrate all new services into a unified launcher
- Maintain orchestrated startup sequence
- Ensure clean shutdown of all services

**Current reality**: Repository is transitioning from Windows to macOS. Legacy `.bat` files exist but should be adapted for macOS as needed.

## Technology Stack

**Backend:**
- Python 3 (API servers, data processing)
- PostgreSQL (production database - NO SQLite allowed)
- Flask + Flask-CORS (API endpoints)

**Frontend:**
- Vanilla HTML/CSS/JavaScript
- No frameworks - direct DOM manipulation
- Real-time data updates via fetch API

**Data Sources:**
- FRED API (Treasury yields, economic data, VIX)
- Yahoo Finance (stocks, forex, commodities via yfinance)
- Alpha Vantage (backup forex/commodities)
- CoinGecko (cryptocurrency data)

**Complete Port Mapping:**

| Port | Service | File | Status | Purpose |
|------|---------|------|--------|---------|
| 8888 | Main Web Server | `start_server.py` | Active in BULLETPROOF_STARTUP | Serves all HTML pages |
| 5001 | CFTC API | `cftc_data_api.py` | Active in BULLETPROOF_STARTUP | Commitment of Traders data |
| 9001 | Barometers API | `barometers_api.py` | Available standalone | 10 intermarket leading indicators |
| 9002 | Macro Regime Tracker | `macro_regime_tracker_api.py` | Active in BULLETPROOF_STARTUP | Macro regime analysis |
| 5003 | Breakthrough Insights | `breakthrough_insights_api.py` | Available standalone | 4 parallel AI pattern agents |
| 5002 | Database Backend | `database_backend.py` | Referenced but may not be active | PostgreSQL integration layer |
| 5004 | Market Gauges | `market_gauges_api.py` | Available standalone | 24 market indicators |
| 8082 | Symbol Data API | `simple_symbol_api.py` | Available standalone | Real-time symbol quotes |

**Note**: BULLETPROOF_STARTUP.py currently starts ports 8888, 5001, and 9002. Other APIs can be started individually for development.

## Common Development Commands

### Starting Services

**Main startup (recommended):**
```bash
cd website
python3 BULLETPROOF_STARTUP.py
```

This orchestrated startup guarantees:
- All API servers start in correct dependency order
- Health checks confirm all servers responding before browser launch
- Automatic port conflict resolution
- Browser opens only when everything is 100% ready
- Zero "connection refused" errors

The startup script manages these services:
- Main web server (port 8888)
- CFTC API (port 5001) - COT data
- Macro Regime Tracker API (port 9002)

**Individual API servers (for development/debugging):**
```bash
cd website

# Individual services - only run these if you need to debug a specific service
python3 barometers_api.py              # Port 9001: 10 intermarket indicators
python3 cftc_data_api.py               # Port 5001: Commitment of Traders data
python3 breakthrough_insights_api.py   # Port 5003: 4 parallel AI agents
python3 macro_regime_tracker_api.py    # Port 9002: Macro regime analysis
```

### Checking Running Services

```bash
# Check specific ports
lsof -i :9000  # Main web server
lsof -i :9001  # Barometers API
lsof -i :5001  # CFTC API
lsof -i :5003  # Breakthrough Insights
lsof -i :9002  # Macro Regime Tracker
lsof -i :5002  # Database backend
lsof -i :5004  # Market Gauges
lsof -i :8082  # Symbol Data API

# Check all critical ports at once
lsof -i :9000 -i :9001 -i :5001 -i :5003 -i :5002 -i :5004 -i :8082 -i :9002

# Kill stuck process on a port
kill -9 $(lsof -ti :9001)
```

### Database Setup

**PostgreSQL Configuration:**
```python
DB_CONFIG = {
    'dbname': 'spartan_website_db',
    'user': 'postgres',
    'password': 'postgres',
    'host': 'localhost',
    'port': 5432
}
```

**Database Commands:**
```bash
# Check PostgreSQL status
brew services list | grep postgresql

# Start PostgreSQL
brew services start postgresql

# Connect to database
psql -U postgres -d spartan_website_db

# Run schema file (if needed)
cd website
psql -U postgres -d spartan_website_db -f barometers_schema.sql
```

**Note**: NO SQLite allowed. PostgreSQL only for production-grade reliability.

### API Keys Configuration

Store API keys in `website/.env.barometers`:
```
FRED_API_KEY=your_key_here
ALPHA_VANTAGE_KEY=your_key_here
```

**Note**: API keys may already be configured in existing files. Check `CONFIG_CENTRAL.md` in website directory before asking user.

Get free keys:
- FRED: https://fred.stlouisfed.org/docs/api/api_key.html
- Alpha Vantage: https://www.alphavantage.co/

## High-Level Architecture

### Multi-Service API Architecture

The system uses a microservices architecture where each API server handles specific financial data:

```
BULLETPROOF_STARTUP.py (orchestrator)
    â”‚
    â”œâ”€> Main web server (Port 8888)
    â”‚   â””â”€> Serves all HTML pages (barometers.html, breakthrough_insights.html, etc.)
    â”‚
    â”œâ”€> barometers_api.py (Port 9001)
    â”‚   â””â”€> 10 Intermarket Leading Indicators
    â”‚       â”œâ”€> Tier 1 (6-18 month): Credit spreads (FRED), yield curve (FRED)
    â”‚       â”œâ”€> Tier 2 (3-6 month): Copper/Gold (Yahoo Finance), Baltic Dry
    â”‚       â””â”€> Tier 3 (1-3 month): AUD/JPY (Yahoo Finance), VIX (FRED)
    â”‚       â””â”€> Composite Risk Score (0-100): GREEN/YELLOW/RED status
    â”‚
    â”œâ”€> cftc_data_api.py (Port 5001)
    â”‚   â””â”€> Commitment of Traders data (from CFTC.gov)
    â”‚       â””â”€> COT screener for futures positioning
    â”‚
    â”œâ”€> breakthrough_insights_api.py (Port 5003)
    â”‚   â””â”€> Pattern Discovery Engine (4 parallel AI agents)
    â”‚       â””â”€> Results stored in PostgreSQL + localStorage
    â”‚
    â””â”€> macro_regime_tracker_api.py (Port 9002)
        â””â”€> Macro regime analysis and tracking
```

**Architecture Pattern**: Each API is an independent Flask service that:
- Fetches data from verified external sources (FRED, Yahoo Finance, Polygon.io, CFTC.gov)
- Stores results in PostgreSQL database
- Exposes RESTful endpoints for frontend consumption
- Includes health check endpoints for BULLETPROOF_STARTUP.py validation

### Data Flow & Persistence

**Data Sources** (all verified, no fake data):
1. **FRED API**: Credit spreads, yield curve, VIX, economic indicators
2. **Yahoo Finance** (yfinance): Forex (AUD/JPY), commodities (Copper/Gold), ETFs, indices
3. **Polygon.io**: Real-time stock prices and volume
4. **CoinGecko**: Top 250+ cryptocurrencies by market cap
5. **CFTC.gov**: Official Commitment of Traders reports

**Persistence Layers**:
1. **PostgreSQL** (`spartan_website_db`): All historical data, barometer readings, insights
2. **localStorage** (frontend): Breakthrough insights accumulation (never deleted), user preferences
3. **File System**: `symbols_database.json` (13,000+ instruments, auto-updated every 24h)

### Symbol Database System

**CRITICAL**: Single global symbol database at `website/symbols_database.json`

Contains 13,000+ instruments:
- 12,200+ stocks (all US + 480 international from 26 exchanges)
- 43 futures (index, energy, metals, agriculture, bonds)
- 41 forex pairs (majors, crosses, exotics)
- 250+ cryptocurrencies
- 100+ ETFs
- 18 global indices

**Never:**
- Create separate symbol databases for individual pages
- Hardcode symbol lists in HTML/JavaScript
- Duplicate symbols across multiple files

**Always:**
- Load from `symbols_database.json` via fetch
- Reference `SYMBOLS_DATABASE_RULE.md` for details

### Key API Patterns

When working with API files in `website/`:
1. **Standard imports**: Flask, Flask-CORS, psycopg2, yfinance, requests
2. **Database config**: Always use `DB_CONFIG` dict with PostgreSQL credentials
3. **API keys**: Load from `.env.barometers` file or environment variables
4. **Health endpoints**: Include `/api/health` or similar for startup validation
5. **Error handling**: Never return fake data - return error message or "Data not available"
6. **Data sources**: Comment which external API provides each data point (FRED, Yahoo Finance, etc.)

### Autonomous Systems

**1. Bulletproof Startup** (`website/BULLETPROOF_STARTUP.py`):
- Orchestrated multi-service startup with dependency management
- Port conflict detection and automatic cleanup
- Health checks for each service before proceeding
- Only opens browser when all critical services are confirmed running
- Prevents "connection refused" and "API not responding" errors

**2. Symbol Database Updater** (`website/autonomous_symbol_downloader.py`):
- Scheduled updates every 24 hours
- Maintains `symbols_database.json` with 13,000+ instruments
- Sources: NASDAQ/NYSE APIs, international exchanges, crypto APIs

**3. Data Validation** (`website/AUTONOMOUS_MATH_RANDOM_FIXER.py`):
- Scans codebase for prohibited Math.random() usage in financial contexts
- Enforces PLATINUM RULE #1 automatically
- Generates violation reports

### Intermarket Barometers System

**Purpose**: Predict market direction 6-18 months in advance

**Tier 1 (6-18 month lead):**
- Credit spreads (HY & IG via FRED)
- Yield curve (10Y-2Y via FRED)
- China credit impulse

**Tier 2 (3-6 month lead):**
- Copper/Gold ratio (Yahoo Finance)
- Baltic Dry Index
- Market breadth metrics

**Tier 3 (1-3 month lead):**
- AUD/JPY (ultimate risk-on/off pair)
- VIX (volatility index)
- Put/Call ratios
- Emerging markets (Yahoo Finance)

**Composite Risk Score**: 0-100 scale
- 75-100 (GREEN): Markets healthy
- 50-74 (YELLOW): Moderate caution
- 25-49 (YELLOW): Multiple stress signals
- 0-24 (RED): Crisis conditions

## Key Pages & Features

**Main Analysis Pages:**
- `barometers.html` - Intermarket barometers dashboard
- `breakthrough_insights.html` - Pattern discovery
- `asian_session_patterns.html` - Asia session analysis
- `boom_or_bust.html` - Market regime identification
- `complete_cftc_cot_terminal.html` - COT screener
- `bitcoin_intelligence_report.html` - Bitcoin analysis
- `bond_intelligence_report.html` - Bond market analysis
- `copper_intelligence_report.html` - Copper market analysis

**Infrastructure:**
- `admin.html` - System administration
- `barometers_table.html` - Tabular barometer view
- `COMPREHENSIVE_TRADING_JOURNAL.html` - Trade journaling

## Design System

**Spartan Aesthetic** - Dark theme with strategic accents:

```css
:root {
    --bg-dark: #0a1628;         /* Primary background */
    --bg-darker: #050b14;       /* Darker sections */
    --gold: #FFD700;            /* Titles, important accents */
    --green: #00ff88;           /* Success, data display */
    --primary: #0096FF;         /* Links, primary actions */
    --red: #ff6b6b;             /* Alerts, sell signals */
    --orange: #ff9500;          /* VIX theme */
    --yellow: #ffd700;          /* Warning states */
    --purple: #9d4edd;          /* Insights theme */
}
```

**Cache Prevention**: All pages must include:
```html
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
```

## Platform Considerations

**Current Platform**: macOS (Darwin)
**Legacy**: Windows batch scripts (`.bat`) and PowerShell (`.ps1`)

When adapting Windows scripts for macOS:
- Convert `.bat` to `.sh` shell scripts
- Use `python3` instead of `python`
- Replace Windows paths (`C:\Users\...`) with Unix paths
- Use `open` instead of `start` for opening URLs/files
- Replace `taskkill` with `pkill` or `kill` commands
- Use proper Unix process management

## Development Best Practices

1. **Always test data sources** - Verify API responses before displaying
2. **Use environment variables** - Never commit API keys
3. **PostgreSQL only** - No SQLite for production features
4. **Cache prevention** - Implement on all HTML pages
5. **Health checks** - Verify services before launching dependent features
6. **Unified startup** - Integrate new services into orchestrator
7. **Spartan theme** - Maintain color scheme consistency
8. **No standalone scripts** - Follow architecture mantra

## Important Documentation

**Start here first**:
- `website/CLAUDE.md` - More detailed developer guide with comprehensive API documentation
- `website/CONFIG_CENTRAL.md` - **CHECK THIS FIRST** before asking for API keys or config

**Architecture**:
- `website/ARCHITECTURE_MANTRA.md` - Single entry point philosophy ("ALL SCRIPTS CONVERGE TO START_SPARTAN.bat")

**Feature-specific**:
- `website/BAROMETERS_README.md` - Intermarket barometers setup and data sources
- `website/BREAKTHROUGH_INSIGHTS_README.md` - Pattern discovery system with 4 AI agents
- `website/CFTC_API_FIX_README.md` - COT data API setup guide
- `website/COMPLETE_STATUS_NOVEMBER_3_2025.md` - Latest system status snapshot

## Common Development Workflows

### Adding a New API Service

When creating a new API endpoint:
1. Create API file in `website/` (e.g., `new_feature_api.py`)
2. Follow the standard Flask + CORS + PostgreSQL pattern (see existing APIs like `barometers_api.py`)
3. Add health check endpoint (e.g., `/api/health`)
4. Integrate into `BULLETPROOF_STARTUP.py` startup sequence
5. Add corresponding HTML page in `website/`
6. Update `CONFIG_CENTRAL.md` with new API details
7. Test individually, then via BULLETPROOF_STARTUP.py

### Debugging API Issues

**API not responding:**
```bash
# Check if service is running
lsof -i :PORT_NUMBER

# View API logs (if running in background)
# Run API directly to see error output
cd website
python3 problem_api.py
```

**Database issues:**
```bash
# Verify PostgreSQL is running
brew services list | grep postgresql

# Connect to database and check tables
psql -U postgres -d spartan_website_db
\dt  # List tables
```

**Data source issues:**
- Check API keys in `website/.env.barometers`
- Verify external API is reachable (FRED, Yahoo Finance, etc.)
- Look for "Data not available" vs fake data - never use Math.random()

## Testing & Validation

**Before deployment:**
1. Test individual API servers for errors
2. Verify database connections (PostgreSQL must be running)
3. Check all pages load without errors
4. Validate data sources return real data (no Math.random())
5. Test full startup via `BULLETPROOF_STARTUP.py`
6. Confirm browser only opens after all health checks pass

**Common issues:**
- **Port conflicts**: Use `lsof -i :PORT` to find conflicting process, or let BULLETPROOF_STARTUP.py auto-cleanup
- **Missing API keys**: Check `website/.env.barometers` and `website/CONFIG_CENTRAL.md` before asking user
- **PostgreSQL not running**: `brew services start postgresql` (macOS)
- **Stale browser cache**: All HTML pages have cache-busting headers
- **Import errors**: Ensure dependencies installed (`pip install flask flask-cors psycopg2 yfinance requests`)

## Security Notes

- API keys in environment variables only (`.env.barometers`)
- No API keys in source code or commits
- Authentication system exists (`auth_system.py`, `auth_system_secure.py`)
- Database credentials should be configured per environment
